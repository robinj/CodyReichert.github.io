<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>The One True Blog - cl-ses: Sending Emails with Common Lisp and AWS SES</title>
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->
    <link rel="stylesheet"
          href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" media="screen"
          href="../css/screen.css">
    <link rel="stylesheet" type="text/css" media="print"
          href="../css/print.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"
            type="text/javascript"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
    <script src="js/nav.js" type="text/javascript"></script>
    <link rel="stylesheet" type="text/css" href="../css/screen.css" />
    <link rel="stylesheet" type="text/css" media="print" href="../css/print.css" />
  </head>
  <body>
    <div class="container">
      <header>
        <h2>
          The One True Blog
          <small>
            <br/>
            Emacs, programming, and Arch Linux
          </small>
        </h2>
      </header>
      <div class="row">
        <nav id="navbar" class="navbar nav navbar-default col-md-2">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle"
                    data-toggle="collapse" data-target=".navbar-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
          </div>
          <div class="navbar-collapse collapse">
            <ul class="nav tree"><li><a href="../index.html">Home</a></li><li><a href="../archive.html">Archive</a></li><li><a href="../about.html">About</a></li><li><a href="../contact.html">Contact</a></li></ul>
          </div>
        </nav>
        <main role="main" class="col-md-10">
          <h1 id="cl-ses-sending-emails-with-common-lisp-and-aws-ses"><code>cl-ses</code>: Sending Emails with Common Lisp and AWS SES</h1>
<p>I’ve been enjoying using Common Lisp lately. After going through the first half of <a href="http://www.gigamonkeys.com/book/">Practical Common Lisp</a> (highly recommended), I wanted to write some scripts to automate some of my own tasks. We use AWS for most of our infrastraucture at <a href="https://simplyrets.com">SimplyRETS</a> and <a href="http://reichertbrothers.com">Reichert Brothers</a>, and run jobs to check how our API’s are holding up. Naturally, I wanted to automate some of that and send out an email when reports are generated.</p>
<p>In case you don’t want to read the rest: <a href="https://github.com/CodyReichert/cl-ses">Here’s the code</a></p>
<h2 id="options">Options</h2>
<p>There are a few AWS libraries out there for Common Lisp<sup>1</sup>, but I couldn’t find one that supported SES - except for <a href="http://www.obrezan.com/lisp/aws-ses/">aws-ses</a>. The problem I had with aws-ses is that it only works with LispWorks - which is perfectly fine, but I’ve been using SBCL and wanted something with a bit more flexibility.</p>
<p>One a side note, if you <em>are</em> using LispWorks - <code>aws-ses</code> is really cool since the author wrote his own hmac, sha1, and base64 algorithms with 0 dependencies.</p>
<h2 id="cl-ses">CL-SES</h2>
<p>The app I wanted to send email from was running in SBCL - so I decided a port of aws-ses would be the right thing to do.</p>
<p>I put up <a href="https://github.com/CodyReichert/cl-ses">cl-ses</a> on GithHub the other day after porting all of the LispWorks specific function. Specifically, the use of <code>comm</code> for the tcp connection was the major blocker. I decided against porting <code>comm</code> to <code>sb-bsd-ports</code> and opted for bringing in <a href="http://weitz.de/drakma/">Drakma</a>, which is an awesome HTTP Library that has already hashed out the differences between Lisp implementations.</p>
<p>Losing the “no dependency” badge and adding the “1 dependency, but multiple implementations” badge was the best route - especially since there seems to be a lack of any high level email libraries.</p>
<h3 id="usage">Usage</h3>
<p>I changed up a bit of code in order to get the signing algorthims to work with Drakma’s headers, but the library stayed very simple - only exposing one <code>send-email</code> function. Here’s all it takes to send an email:</p>
<pre class="lisp"><code>  (cl-ses:send-email :from &quot;me@example.com&quot;
                     :to &quot;you@example.com&quot;
                     :subject &quot;Hello from CL-SES&quot;
                     :message &quot;The body of the email message&quot;
                     :aws-access-key &quot;XXXXXX&quot;
</code></pre>
<p><code>send-email</code> returns <code>T</code> if the status was 200 (OK), and <code>NIL</code> otherwise. In the future I’ll hopefully have implemented better error reporting.</p>
<p>You can easily send to multiple recipients:</p>
<pre class="lisp"><code>  (cl-ses:send-email :from &quot;me@example.com&quot;
                     :to &quot;first@example.com,second@example.com,third@example.com&quot;
                     :subject &quot;Hello from CL-SES&quot;
                     :message &quot;The body of the email message&quot;
                     :aws-access-key &quot;XXXXXX&quot;
                     :aws-secret-key &quot;XXXXXXXXXXX&quot;)</code></pre>
<p>I’m working on extending this to support more of AWS’s features, allow for a lot of the obvious settings (like the AWS region), provide better error hanlding, and built in support for HTML emails - but other than that it’s working great so far.</p>
<h2 id="footnotes">Footnotes</h2>
<p>1 - <a href="https://github.com/xach/zpb-aws">zpb-aws</a> and <a href="https://github.com/hargettp/hh-aws">hh-aws</a> are the two I found.</p>
<p>:: Cody Reichert</p>
        </main>
      </div>
      <footer>
        powered by <a href="https://github.com/jgm/yst">yst</a>
      </footer>
    </div>
  </body>
</html>